name: Deploy to DigitalOcean VPS

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy and setup VPS
        uses: appleboy/ssh-action@v1.0.3
        env:
          ENV_FILE: ${{ secrets.ENV_FILE }}
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          envs: ENV_FILE
          script: |
            set -e
            
            echo "ðŸ“¥ Pulling latest code..."
            cd /srv/mv42
            git fetch origin
            git reset --hard origin/main
            
            echo "ðŸ” Creating .env from ENV_FILE secret..."
            printf "%s\n" "${ENV_FILE}" > /srv/mv42/.env
            echo "âœ… .env file created"            echo "ðŸ“¦ Installing dependencies..."
            npm install --omit=dev
            
            echo "ðŸ”§ Setting up Nginx..."
            # Copy and link nginx config
            sudo cp /srv/mv42/nginx/mv42.conf /etc/nginx/sites-available/mv42
            sudo ln -sf /etc/nginx/sites-available/mv42 /etc/nginx/sites-enabled/mv42
            
            # Update SSL paths to use mv42.dev certificate
            sudo sed -i 's|/etc/letsencrypt/live/app.mv42.dev/|/etc/letsencrypt/live/mv42.dev/|g' /etc/nginx/sites-available/mv42
            
            # Test and reload nginx
            sudo nginx -t && sudo systemctl reload nginx
            
            echo "ðŸš€ Ensuring PM2 is available..."
            command -v pm2 >/dev/null 2>&1 || sudo npm install -g pm2
            
            echo "ðŸš€ Starting/Reloading PM2..."
            # Stop all existing processes to avoid old apps
            pm2 delete all 2>/dev/null || true
            
            # Start with ecosystem config (root index.js serves /)
            pm2 start /srv/mv42/deploy/ecosystem.config.js
            pm2 save
            
            echo "âœ… Deployment completed successfully!"
            echo ""
            pm2 status
